<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Almoxarifado de Medicamentos - Aprimorado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab.active {
            background: white;
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            margin-bottom: -2px;
        }

        .nav-tab:hover {
            background: #f1f5f9;
            color: #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn-primary {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #25eb56;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-success:hover {
            background: #25eb56;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .dashboard {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 24px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.blue { background: #dbeafe; }
        .stat-card.red { background: #fee2e2; }
        .stat-card.orange { background: #fed7aa; }
        .stat-card.green { background: #dcfce7; }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .blue .stat-info h3, .blue .stat-info p { color: #1e40af; }
        .red .stat-info h3, .red .stat-info p { color: #dc2626; }
        .orange .stat-info h3, .orange .stat-info p { color: #ea580c; }
        .green .stat-info h3, .green .stat-info p { color: #16a34a; }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 45px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .form-section {
            padding: 30px;
            background: #f8fafc;
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .table-section {
            padding: 30px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #f8fafc;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px 0;
        }

        .status-good { background: #dcfce7; color: #16a34a; }
        .status-warning { background: #fef3c7; color: #d97706; }
        .status-danger { background: #fee2e2; color: #dc2626; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .medication-info {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .medication-detail {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .date-info {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .stock-info {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .price-info {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Notificações */
        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 16px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        .notification.error { border-left-color: #ef4444; }
        .notification.warning { border-left-color: #f59e0b; }
        .notification.success { border-left-color: #10b981; }
        .notification.info { border-left-color: #3b82f6; }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6b7280;
        }

        .notification-body {
            font-size: 14px;
            color: #6b7280;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Alertas Dashboard */
        .alerts-section {
            margin-bottom: 30px;
        }

        .alert-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item.critical { border-left-color: #ef4444; }
        .alert-item.warning { border-left-color: #f59e0b; }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-icon.critical { color: #ef4444; }
        .alert-icon.warning { color: #f59e0b; }

        .alert-text {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-description {
            font-size: 14px;
            color: #6b7280;
        }

        /* Histórico */
        .history-item {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .history-icon.entrada { background: #10b981; }
        .history-icon.saida { background: #ef4444; }
        .history-icon.ajuste { background: #f59e0b; }
        .history-icon.edicao { background: #3b82f6; }

        .history-content {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .history-meta {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            gap: 16px;
        }

        /* Gráficos */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
        }

        select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 2rem;
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .notifications {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Notificações -->
    <div class="notifications" id="notifications"></div>

    <div class="container">
        <div class="card">
            <!-- Header -->
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h1><i class="fas fa-pills"></i>Sistema de Almoxarifado de Medicamentos</h1>
                        <p>Controle completo de estoque farmacêutico com gestão avançada</p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-success" onclick="generatePDF()">
                            <i class="fas fa-file-pdf"></i>
                            Gerar PDF
                        </button>
                        <button class="btn-primary" onclick="showAddForm()">
                            <i class="fas fa-plus"></i>
                            Adicionar Medicamento
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </button>
                <button class="nav-tab" onclick="showTab('medications')">
                    <i class="fas fa-pills"></i>
                    Medicamentos
                </button>
                <button class="nav-tab" onclick="showTab('movements')">
                    <i class="fas fa-exchange-alt"></i>
                    Movimentações
                </button>
                <button class="nav-tab" onclick="showTab('history')">
                    <i class="fas fa-history"></i>
                    Histórico
                </button>
                <button class="nav-tab" onclick="showTab('reports')">
                    <i class="fas fa-chart-bar"></i>
                    Relatórios
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="dashboard">
                    <!-- Alertas Prioritários -->
                    <div class="alerts-section" id="alertsSection">
                        <h3 style="margin-bottom: 16px; color: #1f2937;">
                            <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                            Alertas Prioritários
                        </h3>
                        <div id="priorityAlerts"></div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card blue" onclick="showTab('medications')">
                            <div class="stat-info">
                                <h3 id="totalMeds">0</h3>
                                <p>Total de Medicamentos</p>
                            </div>
                            <i class="fas fa-pills" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                        <div class="stat-card red" onclick="filterAndShowMedications('expiring')">
                            <div class="stat-info">
                                <h3 id="expiringMeds">0</h3>
                                <p>Próximos ao Vencimento</p>
                            </div>
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                        <div class="stat-card orange" onclick="filterAndShowMedications('lowStock')">
                            <div class="stat-info">
                                <h3 id="lowStockMeds">0</h3>
                                <p>Estoque Baixo</p>
                            </div>
                            <i class="fas fa-box-open" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-info">
                                <h3 id="totalValue">R$ 0,00</h3>
                                <p>Valor Total</p>
                            </div>
                            <i class="fas fa-dollar-sign" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medications Tab -->
            <div class="tab-content" id="medications">
                <div class="dashboard" style="border-bottom: 1px solid #e2e8f0;">
                    <div class="controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Buscar por nome ou lote..." oninput="filterMedications()">
                        </div>
                        <select id="filterSelect" onchange="filterMedications()">
                            <option value="all">Todos</option>
                            <option value="expiring">Próximos ao Vencimento</option>
                            <option value="lowStock">Estoque Baixo</option>
                            <option value="good">Status OK</option>
                        </select>
                    </div>
                </div>

                <!-- Add/Edit Form -->
                <div class="form-section" id="formSection">
                    <h3 style="margin-bottom: 20px; font-size: 1.5rem;" id="formTitle">Adicionar Novo Medicamento</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome do Medicamento *</label>
                            <input type="text" id="medName" required>
                        </div>
                        <div class="form-group">
                            <label>Lote *</label>
                            <input type="text" id="medBatch" required>
                        </div>
                        <div class="form-group">
                            <label>Fabricante *</label>
                            <input type="text" id="medManufacturer" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Compra *</label>
                            <input type="date" id="medPurchaseDate" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Chegada *</label>
                            <input type="date" id="medArrivalDate" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Vencimento *</label>
                            <input type="date" id="medExpirationDate" required>
                        </div>
                        <div class="form-group">
                            <label>Quantidade *</label>
                            <input type="number" id="medQuantity" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Preço Unitário (R$) *</label>
                            <input type="number" id="medUnitPrice" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Localização *</label>
                            <input type="text" id="medLocation" required>
                        </div>
                        <div class="form-group">
                            <label>Estoque Mínimo *</label>
                            <input type="number" id="medMinStock" min="0" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="saveMedication()">
                            <i class="fas fa-save"></i>
                            <span id="saveButtonText">Adicionar</span>
                        </button>
                        <button class="btn-secondary" onclick="hideForm()">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                    </div>
                </div>

                <!-- Medications Table -->
                <div class="table-section">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Medicamento</th>
                                    <th>Lote / Localização</th>
                                    <th>Datas</th>
                                    <th>Estoque</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="medicationsTable">
                            </tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-pills"></i>
                        <p>Nenhum medicamento encontrado</p>
                    </div>
                </div>
            </div>

            <!-- Movements Tab -->
            <div class="tab-content" id="movements">
                <div class="dashboard">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">Registrar Movimentação</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px; color: #10b981;">
                                <i class="fas fa-plus-circle"></i> Entrada de Estoque
                            </h4>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Medicamento</label>
                                <select id="entryMedSelect">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Quantidade</label>
                                <input type="number" id="entryQuantity" min="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Motivo</label>
                                <input type="text" id="entryReason" placeholder="Ex: Compra, Devolução...">
                            </div>
                            <button class="btn-success" onclick="registerMovement('entrada')">
                                <i class="fas fa-plus"></i>
                                Registrar Entrada
                            </button>
                        </div>

                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px; color: #ef4444;">
                                <i class="fas fa-minus-circle"></i> Saída de Estoque
                            </h4>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Medicamento</label>
                                <select id="exitMedSelect">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Quantidade</label>
                                <input type="number" id="exitQuantity" min="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Motivo</label>
                                <input type="text" id="exitReason" placeholder="Ex: Dispensação, Perda...">
                            </div>
                            <button class="btn-warning" onclick="registerMovement('saida')">
                                <i class="fas fa-minus"></i>
                                Registrar Saída
                            </button>
                        </div>

                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px; color: #f59e0b;">
                                <i class="fas fa-edit"></i> Ajuste de Estoque
                            </h4>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Medicamento</label>
                                <select id="adjustMedSelect">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Nova Quantidade</label>
                                <input type="number" id="adjustQuantity" min="0">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Motivo</label>
                                <input type="text" id="adjustReason" placeholder="Ex: Inventário, Vencimento...">
                            </div>
                            <button class="btn-warning" onclick="registerMovement('ajuste')">
                                <i class="fas fa-edit"></i>
                                Registrar Ajuste
                            </button>
                        </div>
                    </div>

                    <!-- Movimentações Recentes -->
                    <h3 style="margin-bottom: 20px; color: #1f2937;">Movimentações Recentes</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Medicamento</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Estoque Anterior</th>
                                    <th>Estoque Atual</th>
                                    <th>Motivo</th>
                                </tr>
                            </thead>
                            <tbody id="movementsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="history">
                <div class="dashboard">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1f2937;">Histórico Completo</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="historyFilter" onchange="filterHistory()">
                                <option value="all">Todas as atividades</option>
                                <option value="entrada">Entradas</option>
                                <option value="saida">Saídas</option>
                                <option value="ajuste">Ajustes</option>
                                <option value="edicao">Edições</option>
                            </select>
                            <button class="btn-secondary" onclick="clearHistory()">
                                <i class="fas fa-trash"></i>
                                Limpar Histórico
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div id="historyContainer">
                            <!-- Histórico será preenchido dinamicamente -->
                        </div>
                        <div class="empty-state" id="emptyHistory" style="display: none;">
                            <i class="fas fa-history"></i>
                            <p>Nenhum registro no histórico</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <div class="dashboard">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">Relatórios e Análises</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px;">
                                <i class="fas fa-file-alt"></i> Relatório de Vencimentos
                            </h4>
                            <p style="color: #6b7280; margin-bottom: 15px;">
                                Medicamentos próximos ao vencimento nos próximos dias
                            </p>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <input type="number" id="expiryDays" value="30" min="1" max="365" 
                                       style="width: 80px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <span style="align-self: center;">dias</span>
                            </div>
                            <button class="btn-primary" onclick="generateExpiryReport()">
                                <i class="fas fa-calendar-times"></i>
                                Gerar Relatório
                            </button>
                        </div>

                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px;">
                                <i class="fas fa-box"></i> Relatório de Estoque Baixo
                            </h4>
                            <p style="color: #6b7280; margin-bottom: 15px;">
                                Medicamentos abaixo do estoque mínimo
                            </p>
                            <button class="btn-primary" onclick="generateLowStockReport()">
                                <i class="fas fa-exclamation-triangle"></i>
                                Gerar Relatório
                            </button>
                        </div>

                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px;">
                                <i class="fas fa-chart-line"></i> Relatório de Movimentações
                            </h4>
                            <p style="color: #6b7280; margin-bottom: 15px;">
                                Histórico de movimentações por período
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                                <input type="date" id="movStartDate" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <input type="date" id="movEndDate" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            </div>
                            <button class="btn-primary" onclick="generateMovementReport()">
                                <i class="fas fa-exchange-alt"></i>
                                Gerar Relatório
                            </button>
                        </div>
                    </div>

                    <!-- Área de exibição dos relatórios -->
                    <div id="reportResults" style="display: none;">
                        <div class="card">
                            <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                                <h4 id="reportTitle" style="margin-bottom: 10px;"></h4>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-success" onclick="exportReportPDF()">
                                        <i class="fas fa-file-pdf"></i>
                                        Exportar PDF
                                    </button>
                                    <button class="btn-secondary" onclick="closeReport()">
                                        <i class="fas fa-times"></i>
                                        Fechar
                                    </button>
                                </div>
                            </div>
                            <div style="padding: 20px;">
                                <div id="reportContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let medications = [];
        let movements = [];
        let history = [];
        let editingId = null;
        let currentReportData = null;

        // Sistema de notificações
        function showNotification(type, title, message) {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                error: 'fas fa-times-circle',
                warning: 'fas fa-exclamation-triangle',
                success: 'fas fa-check-circle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        <i class="${icons[type]}"></i>
                        ${title}
                    </div>
                    <button class="notification-close" onclick="closeNotification(this)">×</button>
                </div>
                <div class="notification-body">${message}</div>
            `;
            
            notifications.appendChild(notification);
            
            // Auto close após 5 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function closeNotification(button) {
            button.closest('.notification').remove();
        }

        // Navegação entre abas
        function showTab(tabName) {
            // Remover active de todas as abas
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Carregar conteúdo específico da aba
            if (tabName === 'dashboard') {
                updateDashboard();
                updateCharts();
            } else if (tabName === 'movements') {
                populateMovementSelects();
                renderMovements();
            } else if (tabName === 'history') {
                renderHistory();
            }
        }

        // Função para salvar dados
        function saveData() {
            localStorage.setItem('pharmacyMedications', JSON.stringify(medications));
            localStorage.setItem('pharmacyMovements', JSON.stringify(movements));
            localStorage.setItem('pharmacyHistory', JSON.stringify(history));
        }

        // Função para carregar dados
        function loadData() {
            const savedMedications = localStorage.getItem('pharmacyMedications');
            const savedMovements = localStorage.getItem('pharmacyMovements');
            const savedHistory = localStorage.getItem('pharmacyHistory');
            
            if (savedMedications) {
                medications = JSON.parse(savedMedications);
            } else {
                initializeDefaultData();
            }
            
            if (savedMovements) {
                movements = JSON.parse(savedMovements);
            }
            
            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }
        }

        // Dados de exemplo
        function initializeDefaultData() {
            medications = [
                {
                    id: 1,
                    name: 'Paracetamol 500mg',
                    batch: 'PAR2024001',
                    manufacturer: 'Laboratório ABC',
                    purchaseDate: '2024-07-15',
                    arrivalDate: '2024-07-18',
                    expirationDate: '2026-07-15',
                    quantity: 500,
                    unitPrice: 0.25,
                    location: 'Prateleira A1',
                    minStock: 100
                },
                {
                    id: 2,
                    name: 'Dipirona 500mg',
                    batch: 'DIP2024002',
                    manufacturer: 'Laboratório XYZ',
                    purchaseDate: '2024-06-10',
                    arrivalDate: '2024-06-12',
                    expirationDate: '2025-01-10',
                    quantity: 50,
                    unitPrice: 0.30,
                    location: 'Prateleira A2',
                    minStock: 80
                }
            ];
            
            // Adicionar histórico de criação inicial
            medications.forEach(med => {
                addToHistory('edicao', `Medicamento ${med.name} adicionado ao sistema`, {
                    medicamento: med.name,
                    detalhes: 'Cadastro inicial do sistema'
                });
            });
            
            saveData();
        }

        // Adicionar ao histórico
        function addToHistory(type, description, details = {}) {
            const historyItem = {
                id: Date.now() + Math.random(),
                type: type,
                description: description,
                details: details,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('pt-BR'),
                time: new Date().toLocaleTimeString('pt-BR')
            };
            
            history.unshift(historyItem);
            
            // Limitar histórico a 1000 itens
            if (history.length > 1000) {
                history = history.slice(0, 1000);
            }
            
            saveData();
        }

        // Funções de medicamentos (preservadas do original)
        function showAddForm() {
            document.getElementById('formSection').classList.add('active');
            document.getElementById('formTitle').textContent = 'Adicionar Novo Medicamento';
            document.getElementById('saveButtonText').textContent = 'Adicionar';
            editingId = null;
            clearForm();
        }

        function hideForm() {
            document.getElementById('formSection').classList.remove('active');
            clearForm();
        }

        function clearForm() {
            const inputs = ['medName', 'medBatch', 'medManufacturer', 'medPurchaseDate', 
                           'medArrivalDate', 'medExpirationDate', 'medQuantity', 
                           'medUnitPrice', 'medLocation', 'medMinStock'];
            inputs.forEach(id => document.getElementById(id).value = '');
        }

        function saveMedication() {
            const name = document.getElementById('medName').value;
            const batch = document.getElementById('medBatch').value;
            const manufacturer = document.getElementById('medManufacturer').value;
            const purchaseDate = document.getElementById('medPurchaseDate').value;
            const arrivalDate = document.getElementById('medArrivalDate').value;
            const expirationDate = document.getElementById('medExpirationDate').value;
            const quantity = parseInt(document.getElementById('medQuantity').value);
            const unitPrice = parseFloat(document.getElementById('medUnitPrice').value);
            const location = document.getElementById('medLocation').value;
            const minStock = parseInt(document.getElementById('medMinStock').value);

            if (!name || !batch || !manufacturer || !purchaseDate || !arrivalDate || 
                !expirationDate || isNaN(quantity) || isNaN(unitPrice) || !location || isNaN(minStock)) {
                showNotification('error', 'Erro', 'Por favor, preencha todos os campos obrigatórios');
                return;
            }

            // Validar datas
            if (new Date(purchaseDate) > new Date()) {
                showNotification('error', 'Erro', 'A data de compra não pode ser futura');
                return;
            }

            if (new Date(expirationDate) < new Date()) {
                showNotification('warning', 'Atenção', 'Este medicamento já está vencido');
            }

            const medication = {
                name, batch, manufacturer, purchaseDate, arrivalDate, expirationDate,
                quantity, unitPrice, location, minStock
            };

            if (editingId) {
                const oldMed = medications.find(med => med.id === editingId);
                const index = medications.findIndex(med => med.id === editingId);
                medications[index] = { ...medication, id: editingId };
                
                addToHistory('edicao', `Medicamento ${name} foi editado`, {
                    medicamento: name,
                    alteracoes: `Lote: ${batch}, Quantidade: ${quantity}`
                });
                
                showNotification('success', 'Sucesso', 'Medicamento atualizado com sucesso');
            } else {
                medication.id = Date.now();
                medications.push(medication);
                
                addToHistory('edicao', `Medicamento ${name} foi adicionado ao sistema`, {
                    medicamento: name,
                    lote: batch,
                    quantidade: quantity
                });
                
                showNotification('success', 'Sucesso', 'Medicamento adicionado com sucesso');
            }

            saveData();
            updateDashboard();
            renderMedications();
            hideForm();
        }

        function editMedication(id) {
            const medication = medications.find(med => med.id === id);
            if (!medication) return;

            document.getElementById('medName').value = medication.name;
            document.getElementById('medBatch').value = medication.batch;
            document.getElementById('medManufacturer').value = medication.manufacturer;
            document.getElementById('medPurchaseDate').value = medication.purchaseDate;
            document.getElementById('medArrivalDate').value = medication.arrivalDate;
            document.getElementById('medExpirationDate').value = medication.expirationDate;
            document.getElementById('medQuantity').value = medication.quantity;
            document.getElementById('medUnitPrice').value = medication.unitPrice;
            document.getElementById('medLocation').value = medication.location;
            document.getElementById('medMinStock').value = medication.minStock;

            document.getElementById('formSection').classList.add('active');
            document.getElementById('formTitle').textContent = 'Editar Medicamento';
            document.getElementById('saveButtonText').textContent = 'Atualizar';
            editingId = id;

            // Mostrar aba de medicamentos
            showTab('medications');
            document.querySelector('[onclick="showTab(\'medications\')"]').classList.add('active');
        }

        function deleteMedication(id) {
            const medication = medications.find(med => med.id === id);
            if (!medication) return;
            
            if (confirm('Tem certeza que deseja excluir este medicamento?')) {
                medications = medications.filter(med => med.id !== id);
                
                addToHistory('edicao', `Medicamento ${medication.name} foi removido do sistema`, {
                    medicamento: medication.name,
                    lote: medication.batch,
                    motivo: 'Exclusão pelo usuário'
                });
                
                saveData();
                updateDashboard();
                renderMedications();
                showNotification('info', 'Medicamento Removido', `${medication.name} foi excluído do sistema`);
            }
        }

        // Funções de status (preservadas do original)
        function getDaysUntilExpiration(expirationDate) {
            const today = new Date();
            const expDate = new Date(expirationDate);
            const diffTime = expDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getExpirationStatus(expirationDate) {
            const days = getDaysUntilExpiration(expirationDate);
            if (days < 0) return 'expired';
            if (days <= 30) return 'expiring';
            if (days <= 90) return 'warning';
            return 'good';
        }

        function getStockStatus(quantity, minStock) {
            if (quantity === 0) return 'out';
            if (quantity <= minStock) return 'low';
            return 'good';
        }

        function getStatusBadge(status, days = null) {
            switch(status) {
                case 'expired':
                    return '<span class="status-badge status-danger">Vencido</span>';
                case 'expiring':
                    return `<span class="status-badge status-danger">${days} dias</span>`;
                case 'warning':
                    return `<span class="status-badge status-warning">${days} dias</span>`;
                case 'out':
                    return '<span class="status-badge status-danger">Sem estoque</span>';
                case 'low':
                    return '<span class="status-badge status-warning">Estoque baixo</span>';
                default:
                    return '<span class="status-badge status-good">OK</span>';
            }
        }

        // Dashboard atualizado
        function updateDashboard() {
            const totalMeds = medications.length;
            const expiringMeds = medications.filter(med => {
                const status = getExpirationStatus(med.expirationDate);
                return status === 'expired' || status === 'expiring';
            }).length;
            const lowStockMeds = medications.filter(med => getStockStatus(med.quantity, med.minStock) !== 'good').length;
            const totalValue = medications.reduce((total, med) => total + (med.quantity * med.unitPrice), 0);

            document.getElementById('totalMeds').textContent = totalMeds;
            document.getElementById('expiringMeds').textContent = expiringMeds;
            document.getElementById('lowStockMeds').textContent = lowStockMeds;
            document.getElementById('totalValue').textContent = `R$ ${totalValue.toFixed(2)}`;

            updatePriorityAlerts();
        }

        // Sistema de alertas prioritários
        function updatePriorityAlerts() {
            const alertsContainer = document.getElementById('priorityAlerts');
            const alerts = [];

            // Medicamentos vencidos
            const expiredMeds = medications.filter(med => getExpirationStatus(med.expirationDate) === 'expired');
            expiredMeds.forEach(med => {
                alerts.push({
                    type: 'critical',
                    icon: 'fas fa-times-circle',
                    title: 'Medicamento Vencido',
                    description: `${med.name} (Lote: ${med.batch}) venceu em ${new Date(med.expirationDate).toLocaleDateString('pt-BR')}`,
                    action: () => editMedication(med.id)
                });
            });

            // Medicamentos próximos ao vencimento (30 dias)
            const expiringMeds = medications.filter(med => {
                const status = getExpirationStatus(med.expirationDate);
                return status === 'expiring';
            });
            expiringMeds.forEach(med => {
                const days = getDaysUntilExpiration(med.expirationDate);
                alerts.push({
                    type: 'critical',
                    icon: 'fas fa-exclamation-triangle',
                    title: 'Próximo ao Vencimento',
                    description: `${med.name} (Lote: ${med.batch}) vence em ${days} dias`,
                    action: () => editMedication(med.id)
                });
            });

            // Medicamentos sem estoque
            const outOfStockMeds = medications.filter(med => med.quantity === 0);
            outOfStockMeds.forEach(med => {
                alerts.push({
                    type: 'critical',
                    icon: 'fas fa-box-open',
                    title: 'Sem Estoque',
                    description: `${med.name} (Lote: ${med.batch}) está sem estoque`,
                    action: () => {
                        showTab('movements');
                        document.querySelector('[onclick="showTab(\'movements\')"]').classList.add('active');
                    }
                });
            });

            // Medicamentos com estoque baixo
            const lowStockMeds = medications.filter(med => getStockStatus(med.quantity, med.minStock) === 'low');
            lowStockMeds.forEach(med => {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-exclamation-triangle',
                    title: 'Estoque Baixo',
                    description: `${med.name} (Lote: ${med.batch}) tem apenas ${med.quantity} unidades (mín: ${med.minStock})`,
                    action: () => {
                        showTab('movements');
                        document.querySelector('[onclick="showTab(\'movements\')"]').classList.add('active');
                    }
                });
            });

            // Limitar a 10 alertas mais críticos
            const criticalAlerts = alerts.filter(alert => alert.type === 'critical').slice(0, 5);
            const warningAlerts = alerts.filter(alert => alert.type === 'warning').slice(0, 5);
            const displayAlerts = [...criticalAlerts, ...warningAlerts];

            if (displayAlerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="alert-item" style="border-left-color: #10b981;">
                        <div class="alert-content">
                            <i class="alert-icon fas fa-check-circle" style="color: #10b981;"></i>
                            <div class="alert-text">
                                <div class="alert-title">Tudo em ordem!</div>
                                <div class="alert-description">Nenhum alerta crítico no momento</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = displayAlerts.map(alert => `
                    <div class="alert-item ${alert.type}" onclick="${alert.action ? 'this.onclick = () => {}; (' + alert.action.toString() + ')()' : ''}">
                        <div class="alert-content">
                            <i class="alert-icon ${alert.icon} ${alert.type}"></i>
                            <div class="alert-text">
                                <div class="alert-title">${alert.title}</div>
                                <div class="alert-description">${alert.description}</div>
                            </div>
                        </div>
                        ${alert.action ? '<i class="fas fa-chevron-right" style="color: #6b7280;"></i>' : ''}
                    </div>
                `).join('');
            }
        }

        // Filtros e busca
        function filterMedications() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterValue = document.getElementById('filterSelect').value;

            const filtered = medications.filter(med => {
                const matchesSearch = med.name.toLowerCase().includes(searchTerm) ||
                                    med.batch.toLowerCase().includes(searchTerm);

                if (filterValue === 'all') return matchesSearch;
                if (filterValue === 'expiring') {
                    const status = getExpirationStatus(med.expirationDate);
                    return matchesSearch && (status === 'expired' || status === 'expiring');
                }
                if (filterValue === 'lowStock') {
                    return matchesSearch && getStockStatus(med.quantity, med.minStock) !== 'good';
                }
                if (filterValue === 'good') {
                    const expStatus = getExpirationStatus(med.expirationDate);
                    const stockStatus = getStockStatus(med.quantity, med.minStock);
                    return matchesSearch && expStatus === 'good' && stockStatus === 'good';
                }
                return matchesSearch;
            });

            renderMedications(filtered);
        }

        function filterAndShowMedications(filter) {
            showTab('medications');
            document.querySelector('[onclick="showTab(\'medications\')"]').classList.add('active');
            document.getElementById('filterSelect').value = filter;
            filterMedications();
        }

        function renderMedications(filteredMeds = medications) {
            const tbody = document.getElementById('medicationsTable');
            const emptyState = document.getElementById('emptyState');

            if (filteredMeds.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = filteredMeds.map(med => {
                const expStatus = getExpirationStatus(med.expirationDate);
                const stockStatus = getStockStatus(med.quantity, med.minStock);
                const daysUntilExp = getDaysUntilExpiration(med.expirationDate);

                return `
                    <tr>
                        <td>
                            <div class="medication-info">${med.name}</div>
                            <div class="medication-detail">${med.manufacturer}</div>
                        </td>
                        <td>
                            <div class="medication-info">${med.batch}</div>
                            <div class="medication-detail">${med.location}</div>
                        </td>
                        <td class="date-info">
                            <div>Compra: ${new Date(med.purchaseDate).toLocaleDateString('pt-BR')}</div>
                            <div>Chegada: ${new Date(med.arrivalDate).toLocaleDateString('pt-BR')}</div>
                            <div>Vencimento: ${new Date(med.expirationDate).toLocaleDateString('pt-BR')}</div>
                        </td>
                        <td>
                            <div class="stock-info">${med.quantity} unidades</div>
                            <div class="medication-detail">Mín: ${med.minStock}</div>
                        </td>
                        <td class="price-info">
                            <div>Unit: R$ ${med.unitPrice.toFixed(2)}</div>
                            <div>Total: R$ ${(med.quantity * med.unitPrice).toFixed(2)}</div>
                        </td>
                        <td>
                            ${getStatusBadge(expStatus, daysUntilExp > 0 ? daysUntilExp : null)}<br>
                            ${getStatusBadge(stockStatus)}
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn-small btn-edit" onclick="editMedication(${med.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-small btn-delete" onclick="deleteMedication(${med.id})" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Sistema de movimentações
        function populateMovementSelects() {
            const entrySelect = document.getElementById('entryMedSelect');
            const exitSelect = document.getElementById('exitMedSelect');
            const adjustSelect = document.getElementById('adjustMedSelect');
            
            const options = medications.map(med => 
                `<option value="${med.id}">${med.name} - ${med.batch} (${med.quantity} un.)</option>`
            ).join('');
            
            entrySelect.innerHTML = '<option value="">Selecione...</option>' + options;
            exitSelect.innerHTML = '<option value="">Selecione...</option>' + options;
            adjustSelect.innerHTML = '<option value="">Selecione...</option>' + options;
        }

        function registerMovement(type) {
            let medId, quantity, reason;
            
            if (type === 'entrada') {
                medId = document.getElementById('entryMedSelect').value;
                quantity = parseInt(document.getElementById('entryQuantity').value);
                reason = document.getElementById('entryReason').value;
            } else if (type === 'saida') {
                medId = document.getElementById('exitMedSelect').value;
                quantity = parseInt(document.getElementById('exitQuantity').value);
                reason = document.getElementById('exitReason').value;
            } else if (type === 'ajuste') {
                medId = document.getElementById('adjustMedSelect').value;
                quantity = parseInt(document.getElementById('adjustQuantity').value);
                reason = document.getElementById('adjustReason').value;
            }

            if (!medId || isNaN(quantity) || quantity < 0 || !reason) {
                showNotification('error', 'Erro', 'Por favor, preencha todos os campos');
                return;
            }

            const medication = medications.find(med => med.id == medId);
            if (!medication) {
                showNotification('error', 'Erro', 'Medicamento não encontrado');
                return;
            }

            const oldQuantity = medication.quantity;
            let newQuantity = oldQuantity;

            if (type === 'entrada') {
                newQuantity = oldQuantity + quantity;
            } else if (type === 'saida') {
                if (quantity > oldQuantity) {
                    showNotification('error', 'Erro', 'Quantidade de saída maior que o estoque disponível');
                    return;
                }
                newQuantity = oldQuantity - quantity;
            } else if (type === 'ajuste') {
                newQuantity = quantity;
            }

            // Atualizar estoque
            medication.quantity = newQuantity;

            // Registrar movimentação
            const movement = {
                id: Date.now(),
                medicationId: medId,
                medicationName: medication.name,
                medicationBatch: medication.batch,
                type: type,
                quantity: quantity,
                oldQuantity: oldQuantity,
                newQuantity: newQuantity,
                reason: reason,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('pt-BR'),
                time: new Date().toLocaleTimeString('pt-BR')
            };

            movements.unshift(movement);

            // Adicionar ao histórico
            const typeNames = {
                'entrada': 'Entrada de estoque',
                'saida': 'Saída de estoque',
                'ajuste': 'Ajuste de estoque'
            };

            addToHistory(type, `${typeNames[type]} - ${medication.name}`, {
                medicamento: medication.name,
                lote: medication.batch,
                quantidade: quantity,
                estoqueAnterior: oldQuantity,
                estoqueAtual: newQuantity,
                motivo: reason
            });

            // Limpar campos
            if (type === 'entrada') {
                document.getElementById('entryMedSelect').value = '';
                document.getElementById('entryQuantity').value = '';
                document.getElementById('entryReason').value = '';
            } else if (type === 'saida') {
                document.getElementById('exitMedSelect').value = '';
                document.getElementById('exitQuantity').value = '';
                document.getElementById('exitReason').value = '';
            } else if (type === 'ajuste') {
                document.getElementById('adjustMedSelect').value = '';
                document.getElementById('adjustQuantity').value = '';
                document.getElementById('adjustReason').value = '';
            }

            saveData();
            updateDashboard();
            populateMovementSelects();
            renderMovements();

            const typeMessages = {
                'entrada': 'Entrada registrada com sucesso',
                'saida': 'Saída registrada com sucesso',
                'ajuste': 'Ajuste registrado com sucesso'
            };

            showNotification('success', 'Sucesso', typeMessages[type]);

            // Verificar alertas após movimentação
            checkStockAlerts(medication);
        }

        function checkStockAlerts(medication) {
            const stockStatus = getStockStatus(medication.quantity, medication.minStock);
            const expStatus = getExpirationStatus(medication.expirationDate);

            if (stockStatus === 'out') {
                showNotification('error', 'Estoque Esgotado', 
                    `${medication.name} ficou sem estoque!`);
            } else if (stockStatus === 'low') {
                showNotification('warning', 'Estoque Baixo', 
                    `${medication.name} está com estoque baixo (${medication.quantity} unidades)`);
            }

            if (expStatus === 'expired') {
                showNotification('error', 'Medicamento Vencido', 
                    `${medication.name} está vencido desde ${new Date(medication.expirationDate).toLocaleDateString('pt-BR')}`);
            } else if (expStatus === 'expiring') {
                const days = getDaysUntilExpiration(medication.expirationDate);
                showNotification('warning', 'Próximo ao Vencimento', 
                    `${medication.name} vence em ${days} dias`);
            }
        }

        function renderMovements() {
            const tbody = document.getElementById('movementsTable');
            const recentMovements = movements.slice(0, 20); // Mostrar apenas os 20 mais recentes

            if (recentMovements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">Nenhuma movimentação registrada</td></tr>';
                return;
            }

            const typeIcons = {
                'entrada': '<i class="fas fa-plus-circle" style="color: #10b981;"></i>',
                'saida': '<i class="fas fa-minus-circle" style="color: #ef4444;"></i>',
                'ajuste': '<i class="fas fa-edit" style="color: #f59e0b;"></i>'
            };

            const typeNames = {
                'entrada': 'Entrada',
                'saida': 'Saída',
                'ajuste': 'Ajuste'
            };

            tbody.innerHTML = recentMovements.map(mov => `
                <tr>
                    <td>
                        <div>${mov.date}</div>
                        <div style="font-size: 0.85rem; color: #6b7280;">${mov.time}</div>
                    </td>
                    <td>
                        <div class="medication-info">${mov.medicationName}</div>
                        <div class="medication-detail">Lote: ${mov.medicationBatch}</div>
                    </td>
                    <td>
                        ${typeIcons[mov.type]}
                        ${typeNames[mov.type]}
                    </td>
                    <td style="font-weight: 600;">
                        ${mov.type === 'ajuste' ? 
                            `${mov.newQuantity}` : 
                            `${mov.type === 'entrada' ? '+' : '-'}${mov.quantity}`
                        }
                    </td>
                    <td>${mov.oldQuantity}</td>
                    <td style="font-weight: 600;">${mov.newQuantity}</td>
                    <td>${mov.reason}</td>
                </tr>
            `).join('');
        }

        // Sistema de histórico
        function renderHistory(filteredHistory = history) {
            const container = document.getElementById('historyContainer');
            const emptyState = document.getElementById('emptyHistory');

            if (filteredHistory.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            const typeIcons = {
                'entrada': 'fas fa-plus-circle',
                'saida': 'fas fa-minus-circle',
                'ajuste': 'fas fa-edit',
                'edicao': 'fas fa-pen'
            };

            container.innerHTML = filteredHistory.map(item => `
                <div class="history-item">
                    <div class="history-icon ${item.type}">
                        <i class="${typeIcons[item.type]}"></i>
                    </div>
                    <div class="history-content">
                        <div class="history-title">${item.description}</div>
                        <div class="history-description">
                            ${item.details.medicamento ? `Medicamento: ${item.details.medicamento}` : ''}
                            ${item.details.lote ? ` • Lote: ${item.details.lote}` : ''}
                            ${item.details.quantidade ? ` • Quantidade: ${item.details.quantidade}` : ''}
                            ${item.details.motivo ? ` • Motivo: ${item.details.motivo}` : ''}
                        </div>
                        <div class="history-meta">
                            <span><i class="fas fa-calendar"></i> ${item.date}</span>
                            <span><i class="fas fa-clock"></i> ${item.time}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterHistory() {
            const filter = document.getElementById('historyFilter').value;
            const filteredHistory = filter === 'all' ? 
                history : 
                history.filter(item => item.type === filter);
            
            renderHistory(filteredHistory);
        }

        function clearHistory() {
            if (confirm('Tem certeza que deseja limpar todo o histórico? Esta ação não pode ser desfeita.')) {
                history = [];
                saveData();
                renderHistory();
                showNotification('info', 'Histórico Limpo', 'Todo o histórico foi removido');
            }
        }

        // Sistema de gráficos
        function updateCharts() {
            updateStockChart();
            updateStatusChart();
        }

        function updateStockChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            // Dados simulados para evolução dos últimos 30 dias
            const labels = [];
            const data = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                
                // Simular variação de estoque (baseado em movimentações reais se existirem)
                const baseValue = medications.reduce((sum, med) => sum + med.quantity, 0);
                const variation = Math.random() * 100 - 50; // Variação aleatória
                data.push(Math.max(0, baseValue + variation));
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total de Medicamentos',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            }
                        },
                        x: {
                            grid: {
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }

        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            let goodCount = 0;
            let warningCount = 0;
            let criticalCount = 0;
            
            medications.forEach(med => {
                const expStatus = getExpirationStatus(med.expirationDate);
                const stockStatus = getStockStatus(med.quantity, med.minStock);
                
                if (expStatus === 'expired' || stockStatus === 'out') {
                    criticalCount++;
                } else if (expStatus === 'expiring' || expStatus === 'warning' || stockStatus === 'low') {
                    warningCount++;
                } else {
                    goodCount++;
                }
            });

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['OK', 'Atenção', 'Crítico'],
                    datasets: [{
                        data: [goodCount, warningCount, criticalCount],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Sistema de relatórios
        function generateExpiryReport() {
            const days = parseInt(document.getElementById('expiryDays').value) || 30;
            const expiringMeds = medications.filter(med => {
                const daysUntil = getDaysUntilExpiration(med.expirationDate);
                return daysUntil <= days && daysUntil >= 0;
            });

            const expiredMeds = medications.filter(med => getDaysUntilExpiration(med.expirationDate) < 0);

            const reportData = {
                title: `Relatório de Vencimentos (${days} dias)`,
                date: new Date().toLocaleDateString('pt-BR'),
                summary: {
                    total: expiringMeds.length + expiredMeds.length,
                    expiring: expiringMeds.length,
                    expired: expiredMeds.length
                },
                items: [...expiredMeds, ...expiringMeds].map(med => ({
                    name: med.name,
                    batch: med.batch,
                    manufacturer: med.manufacturer,
                    expirationDate: new Date(med.expirationDate).toLocaleDateString('pt-BR'),
                    daysUntil: getDaysUntilExpiration(med.expirationDate),
                    quantity: med.quantity,
                    value: med.quantity * med.unitPrice,
                    location: med.location,
                    status: getDaysUntilExpiration(med.expirationDate) < 0 ? 'Vencido' : 'A vencer'
                }))
            };

            showReport(reportData, 'expiry');
        }

        function generateLowStockReport() {
            const lowStockMeds = medications.filter(med => getStockStatus(med.quantity, med.minStock) !== 'good');

            const reportData = {
                title: 'Relatório de Estoque Baixo',
                date: new Date().toLocaleDateString('pt-BR'),
                summary: {
                    total: lowStockMeds.length,
                    outOfStock: lowStockMeds.filter(med => med.quantity === 0).length,
                    lowStock: lowStockMeds.filter(med => med.quantity > 0).length
                },
                items: lowStockMeds.map(med => ({
                    name: med.name,
                    batch: med.batch,
                    manufacturer: med.manufacturer,
                    currentStock: med.quantity,
                    minStock: med.minStock,
                    difference: med.minStock - med.quantity,
                    location: med.location,
                    value: med.quantity * med.unitPrice,
                    status: med.quantity === 0 ? 'Sem estoque' : 'Estoque baixo'
                }))
            };

            showReport(reportData, 'lowStock');
        }

        function generateMovementReport() {
            const startDate = document.getElementById('movStartDate').value;
            const endDate = document.getElementById('movEndDate').value;

            if (!startDate || !endDate) {
                showNotification('error', 'Erro', 'Por favor, selecione as datas de início e fim');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // Incluir todo o dia final

            const filteredMovements = movements.filter(mov => {
                const movDate = new Date(mov.timestamp);
                return movDate >= start && movDate <= end;
            });

            const reportData = {
                title: `Relatório de Movimentações (${start.toLocaleDateString('pt-BR')} - ${end.toLocaleDateString('pt-BR')})`,
                date: new Date().toLocaleDateString('pt-BR'),
                summary: {
                    total: filteredMovements.length,
                    entries: filteredMovements.filter(mov => mov.type === 'entrada').length,
                    exits: filteredMovements.filter(mov => mov.type === 'saida').length,
                    adjustments: filteredMovements.filter(mov => mov.type === 'ajuste').length
                },
                items: filteredMovements.map(mov => ({
                    date: mov.date,
                    time: mov.time,
                    medicationName: mov.medicationName,
                    batch: mov.medicationBatch,
                    type: mov.type === 'entrada' ? 'Entrada' : mov.type === 'saida' ? 'Saída' : 'Ajuste',
                    quantity: mov.quantity,
                    oldQuantity: mov.oldQuantity,
                    newQuantity: mov.newQuantity,
                    reason: mov.reason
                }))
            };

            showReport(reportData, 'movements');
        }

        function showReport(reportData, type) {
            currentReportData = { data: reportData, type: type };
            document.getElementById('reportTitle').textContent = reportData.title;
            document.getElementById('reportResults').style.display = 'block';

            let content = `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #1f2937; margin-bottom: 15px;">Resumo</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;

            if (type === 'expiry') {
                content += `
                    <div class="stat-card red" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.expired}</h3>
                            <p>Vencidos</p>
                        </div>
                    </div>
                    <div class="stat-card orange" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.expiring}</h3>
                            <p>A Vencer</p>
                        </div>
                    </div>
                    <div class="stat-card blue" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.total}</h3>
                            <p>Total</p>
                        </div>
                    </div>
                `;
            } else if (type === 'lowStock') {
                content += `
                    <div class="stat-card red" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.outOfStock}</h3>
                            <p>Sem Estoque</p>
                        </div>
                    </div>
                    <div class="stat-card orange" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.lowStock}</h3>
                            <p>Estoque Baixo</p>
                        </div>
                    </div>
                    <div class="stat-card blue" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.total}</h3>
                            <p>Total</p>
                        </div>
                    </div>
                `;
            } else if (type === 'movements') {
                content += `
                    <div class="stat-card green" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.entries}</h3>
                            <p>Entradas</p>
                        </div>
                    </div>
                    <div class="stat-card red" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.exits}</h3>
                            <p>Saídas</p>
                        </div>
                    </div>
                    <div class="stat-card orange" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.adjustments}</h3>
                            <p>Ajustes</p>
                        </div>
                    </div>
                    <div class="stat-card blue" style="padding: 15px;">
                        <div class="stat-info">
                            <h3>${reportData.summary.total}</h3>
                            <p>Total</p>
                        </div>
                    </div>
                `;
            }

            content += `
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
            `;

            if (type === 'expiry') {
                content += `
                    <th>Medicamento</th>
                    <th>Lote</th>
                    <th>Fabricante</th>
                    <th>Vencimento</th>
                    <th>Dias</th>
                    <th>Quantidade</th>
                    <th>Valor</th>
                    <th>Status</th>
                `;
            } else if (type === 'lowStock') {
                content += `
                    <th>Medicamento</th>
                    <th>Lote</th>
                    <th>Fabricante</th>
                    <th>Estoque Atual</th>
                    <th>Estoque Mín.</th>
                    <th>Diferença</th>
                    <th>Localização</th>
                    <th>Status</th>
                `;
            } else if (type === 'movements') {
                content += `
                    <th>Data</th>
                    <th>Medicamento</th>
                    <th>Lote</th>
                    <th>Tipo</th>
                    <th>Quantidade</th>
                    <th>Estoque Anterior</th>
                    <th>Estoque Atual</th>
                    <th>Motivo</th>
                `;
            }

            content += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            reportData.items.forEach(item => {
                content += '<tr>';
                
                if (type === 'expiry') {
                    content += `
                        <td>${item.name}</td>
                        <td>${item.batch}</td>
                        <td>${item.manufacturer}</td>
                        <td>${item.expirationDate}</td>
                        <td>${item.daysUntil < 0 ? 'Vencido' : item.daysUntil + ' dias'}</td>
                        <td>${item.quantity}</td>
                        <td>R$ ${item.value.toFixed(2)}</td>
                        <td><span class="status-badge ${item.status === 'Vencido' ? 'status-danger' : 'status-warning'}">${item.status}</span></td>
                    `;
                } else if (type === 'lowStock') {
                    content += `
                        <td>${item.name}</td>
                        <td>${item.batch}</td>
                        <td>${item.manufacturer}</td>
                        <td>${item.currentStock}</td>
                        <td>${item.minStock}</td>
                        <td>${item.difference}</td>
                        <td>${item.location}</td>
                        <td><span class="status-badge ${item.status === 'Sem estoque' ? 'status-danger' : 'status-warning'}">${item.status}</span></td>
                    `;
                } else if (type === 'movements') {
                    content += `
                        <td>${item.date} ${item.time}</td>
                        <td>${item.medicationName}</td>
                        <td>${item.batch}</td>
                        <td>${item.type}</td>
                        <td>${item.quantity}</td>
                        <td>${item.oldQuantity}</td>
                        <td>${item.newQuantity}</td>
                        <td>${item.reason}</td>
                    `;
                }
                
                content += '</tr>';
            });

            content += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = content;
        }

        function exportReportPDF() {
            if (!currentReportData) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { data, type } = currentReportData;

            // Cabeçalho
            doc.setFontSize(18);
            doc.setTextColor(37, 99, 235);
            doc.text(data.title, 20, 20);

            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${data.date} às ${new Date().toLocaleTimeString('pt-BR')}`, 20, 30);

            // Resumo
            let yPos = 45;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumo:', 20, yPos);
            yPos += 10;

            doc.setFontSize(10);
            if (type === 'expiry') {
                doc.text(`• Total de medicamentos: ${data.summary.total}`, 25, yPos);
                doc.text(`• Vencidos: ${data.summary.expired}`, 25, yPos + 7);
                doc.text(`• A vencer: ${data.summary.expiring}`, 25, yPos + 14);
                yPos += 25;
            } else if (type === 'lowStock') {
                doc.text(`• Total de medicamentos: ${data.summary.total}`, 25, yPos);
                doc.text(`• Sem estoque: ${data.summary.outOfStock}`, 25, yPos + 7);
                doc.text(`• Estoque baixo: ${data.summary.lowStock}`, 25, yPos + 14);
                yPos += 25;
            } else if (type === 'movements') {
                doc.text(`• Total de movimentações: ${data.summary.total}`, 25, yPos);
                doc.text(`• Entradas: ${data.summary.entries}`, 25, yPos + 7);
                doc.text(`• Saídas: ${data.summary.exits}`, 25, yPos + 14);
                doc.text(`• Ajustes: ${data.summary.adjustments}`, 25, yPos + 21);
                yPos += 30;
            }

            // Tabela
            let tableData = [];
            let tableHeaders = [];

            if (type === 'expiry') {
                tableHeaders = ['Medicamento', 'Lote', 'Vencimento', 'Dias', 'Qtd', 'Valor', 'Status'];
                tableData = data.items.map(item => [
                    item.name,
                    item.batch,
                    item.expirationDate,
                    item.daysUntil < 0 ? 'Vencido' : item.daysUntil + 'd',
                    item.quantity.toString(),
                    `R$ ${item.value.toFixed(2)}`,
                    item.status
                ]);
            } else if (type === 'lowStock') {
                tableHeaders = ['Medicamento', 'Lote', 'Atual', 'Mín', 'Dif', 'Local', 'Status'];
                tableData = data.items.map(item => [
                    item.name,
                    item.batch,
                    item.currentStock.toString(),
                    item.minStock.toString(),
                    item.difference.toString(),
                    item.location,
                    item.status
                ]);
            } else if (type === 'movements') {
                tableHeaders = ['Data', 'Medicamento', 'Tipo', 'Qtd', 'Anterior', 'Atual', 'Motivo'];
                tableData = data.items.map(item => [
                    item.date,
                    item.medicationName,
                    item.type,
                    item.quantity.toString(),
                    item.oldQuantity.toString(),
                    item.newQuantity.toString(),
                    item.reason
                ]);
            }

            doc.autoTable({
                head: [tableHeaders],
                body: tableData,
                startY: yPos,
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                },
                headStyles: {
                    fillColor: [37, 99, 235],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                },
                margin: { left: 10, right: 10 }
            });

            // Rodapé
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() - 30, doc.internal.pageSize.getHeight() - 10);
            }

            const fileName = `${data.title.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function closeReport() {
            document.getElementById('reportResults').style.display = 'none';
            currentReportData = null;
        }

        // Função para gerar PDF completo (preservada do original)
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurar fonte
            doc.setFont('helvetica');
            
            // Cabeçalho do PDF
            doc.setFontSize(20);
            doc.setTextColor(37, 99, 235);
            doc.text('Sistema de Almoxarifado de Medicamentos', 20, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            const currentDate = new Date().toLocaleDateString('pt-BR');
            const currentTime = new Date().toLocaleTimeString('pt-BR');
            doc.text(`Relatório completo gerado em: ${currentDate} às ${currentTime}`, 20, 30);
            
            // Estatísticas
            const totalMeds = medications.length;
            const expiringMeds = medications.filter(med => {
                const status = getExpirationStatus(med.expirationDate);
                return status === 'expired' || status === 'expiring';
            }).length;
            const lowStockMeds = medications.filter(med => getStockStatus(med.quantity, med.minStock) !== 'good').length;
            const totalValue = medications.reduce((total, med) => total + (med.quantity * med.unitPrice), 0);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumo do Estoque:', 20, 45);
            
            doc.setFontSize(11);
            doc.text(`• Total de Medicamentos: ${totalMeds}`, 25, 55);
            doc.text(`• Próximos ao Vencimento: ${expiringMeds}`, 25, 62);
            doc.text(`• Com Estoque Baixo: ${lowStockMeds}`, 25, 69);
            doc.text(`• Valor Total do Estoque: R$ ${totalValue.toFixed(2)}`, 25, 76);
            
            // Preparar dados da tabela
            const tableData = medications.map(med => {
                const expStatus = getExpirationStatus(med.expirationDate);
                const stockStatus = getStockStatus(med.quantity, med.minStock);
                const daysUntilExp = getDaysUntilExpiration(med.expirationDate);
                
                let expStatusText = 'OK';
                if (expStatus === 'expired') expStatusText = 'Vencido';
                else if (expStatus === 'expiring') expStatusText = `${daysUntilExp} dias`;
                else if (expStatus === 'warning') expStatusText = `${daysUntilExp} dias`;
                
                let stockStatusText = 'OK';
                if (stockStatus === 'out') stockStatusText = 'Sem estoque';
                else if (stockStatus === 'low') stockStatusText = 'Baixo';
                
                return [
                    med.name,
                    med.batch,
                    med.manufacturer,
                    new Date(med.purchaseDate).toLocaleDateString('pt-BR'),
                    new Date(med.expirationDate).toLocaleDateString('pt-BR'),
                    med.quantity.toString(),
                    `R$ ${med.unitPrice.toFixed(2)}`,
                    med.location,
                    expStatusText,
                    stockStatusText
                ];
            });
            
            // Cabeçalhos da tabela
            const tableHeaders = [
                'Medicamento',
                'Lote',
                'Fabricante',
                'Dt. Compra',
                'Dt. Vencimento',
                'Qtd',
                'Preço Unit.',
                'Localização',
                'Status Venc.',
                'Status Estoque'
            ];
            
            // Adicionar tabela ao PDF
            doc.autoTable({
                head: [tableHeaders],
                body: tableData,
                startY: 85,
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                },
                headStyles: {
                    fillColor: [37, 99, 235],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                },
                columnStyles: {
                    0: { cellWidth: 25 }, // Medicamento
                    1: { cellWidth: 20 }, // Lote
                    2: { cellWidth: 20 }, // Fabricante
                    3: { cellWidth: 18 }, // Dt. Compra
                    4: { cellWidth: 18 }, // Dt. Vencimento
                    5: { cellWidth: 12 }, // Quantidade
                    6: { cellWidth: 15 }, // Preço
                    7: { cellWidth: 20 }, // Localização
                    8: { cellWidth: 18 }, // Status Venc.
                    9: { cellWidth: 18 }  // Status Estoque
                },
                margin: { left: 10, right: 10 },
                didDrawCell: function(data) {
                    // Colorir células de status
                    if (data.column.index === 8) { // Status Vencimento
                        const cellValue = data.cell.text[0];
                        if (cellValue === 'Vencido' || (cellValue.includes('dias') && parseInt(cellValue) <= 30)) {
                            data.cell.styles.textColor = [220, 38, 38]; // Vermelho
                        } else if (cellValue.includes('dias') && parseInt(cellValue) <= 90) {
                            data.cell.styles.textColor = [217, 119, 6]; // Amarelo
                        } else {
                            data.cell.styles.textColor = [22, 163, 74]; // Verde
                        }
                    }
                    if (data.column.index === 9) { // Status Estoque
                        const cellValue = data.cell.text[0];
                        if (cellValue === 'Sem estoque' || cellValue === 'Baixo') {
                            data.cell.styles.textColor = [220, 38, 38]; // Vermelho/Laranja
                        } else {
                            data.cell.styles.textColor = [22, 163, 74]; // Verde
                        }
                    }
                }
            });
            
            // Rodapé
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() - 30, doc.internal.pageSize.getHeight() - 10);
                doc.text('Sistema de Almoxarifado de Medicamentos', 20, doc.internal.pageSize.getHeight() - 10);
            }
            
            // Salvar o PDF
            const fileName = `relatorio-completo-medicamentos-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showNotification('success', 'PDF Gerado', 'Relatório completo exportado com sucesso');
        }

        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDashboard();
            renderMedications();
            updateCharts();
            
            // Configurar datas padrão para relatório de movimentações
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(today.getMonth() - 1);
            
            document.getElementById('movStartDate').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('movEndDate').value = today.toISOString().split('T')[0];
            
            // Verificar alertas iniciais
            setTimeout(() => {
                checkInitialAlerts();
            }, 1000);
        });

        // Verificar alertas iniciais
        function checkInitialAlerts() {
            const criticalMeds = medications.filter(med => {
                const expStatus = getExpirationStatus(med.expirationDate);
                const stockStatus = getStockStatus(med.quantity, med.minStock);
                return expStatus === 'expired' || expStatus === 'expiring' || stockStatus === 'out';
            });

            if (criticalMeds.length > 0) {
                showNotification('warning', 'Alertas Importantes', 
                    `Você tem ${criticalMeds.length} medicamento(s) que requer(em) atenção imediata. Verifique o dashboard.`);
            }
        }

        // Adicionar eventos para atualizar selects quando mudar para aba de movimentações
        function showTab(tabName) {
            // Código existente mantido...
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
                setTimeout(() => updateCharts(), 100); // Pequeno delay para garantir que os canvas estejam visíveis
            } else if (tabName === 'movements') {
                populateMovementSelects();
                renderMovements();
            } else if (tabName === 'history') {
                renderHistory();
            } else if (tabName === 'medications') {
                renderMedications();
            }
        }
    </script>
<footer class="container">
    <p style="text-align: center;">Desenvolvido por <a href="https://www.instagram.com/fabiocbd?igsh=MThsZnNwZHlraGQzYw==">Fábio Christian</a></p>
</footer>
</body>
</html>
            
                            